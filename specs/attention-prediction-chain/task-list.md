# 注意力预测链功能任务清单

基于骨干优先原则，按技术风险和完整性排序任务。

## 优先级1：最小验证任务（消除技术风险）

- [x] 1. 验证模型预测功能独立运行 ✅
  - 需求：REQ-1 下一token预测显示
  - 文件：`verify_language_model.py` (已完成)
  - 验证：Console显示 `"我爱中国" → "的"(28.7%)` ✅
  - 风险：AutoModelForCausalLM可行性已确认

## 优先级2：骨干任务（端到端最简流程）

- [x] 2. 修改后端核心算法支持预测 ✅
  - 需求：REQ-1.1, REQ-2.1
  - 文件：`app.py` - `get_attention_visualization_data()`
  - 验证：函数返回5个值包含prediction_info ✅
  - 关键：已改用AutoModelForCausalLM，扩展返回值

- [x] 3. 更新API接口支持预测数据 ✅
  - 需求：REQ-1.4, REQ-2.2
  - 文件：`app.py` - `/visualize` 端点
  - 验证：JSON响应包含prediction字段 ✅
  - 关键：向前端传递预测token和概率

- [x] 4. 实现前端预测token显示 ✅
  - 需求：REQ-1.3, REQ-1.4, REQ-2.2
  - 文件：`app.py` - HTML模板和JavaScript
  - 验证：浏览器显示蓝色预测token "的(28.7%)" ✅
  - 关键：蓝色样式，放置在序列末尾

## 优先级3：完善任务（增强用户体验）

- [x] 5. 实现因果关系视觉增强 ✅
  - 需求：REQ-3.1, REQ-3.2, REQ-3.3
  - 文件：`app.py` - HTML模板CSS和说明文字
  - 验证：说明文字解释红色→蓝色因果关系 ✅
  - 关键：已添加彩色说明文字

- [x] 6. 实现Top-K候选显示（P2功能）
  - 需求：用户体验增强
  - 文件：`app.py` - 后端Top-K逻辑 + 前端悬停显示
  - 验证：鼠标悬停蓝色预测token → 显示前10个候选及概率
  - 关键：后端返回top_candidates，前端tooltip显示

## 优先级4：优化任务（边缘情况处理）

- [ ] 7. 处理特殊token显示
  - 需求：REQ-1.2
  - 文件：`app.py` - token解码逻辑
  - 验证：输入完整句子 → 正确显示 `</s>(概率%)`
  - 关键：特殊token原样显示不隐藏

- [ ] 8. 优化错误处理和用户反馈
  - 需求：通用鲁棒性要求
  - 文件：`app.py` - 异常处理
  - 验证：各种异常输入 → 优雅错误提示而不崩溃
  - 关键：模型加载失败、预测异常等情况

## 验收测试场景

### 场景1：基础预测显示（任务4完成后）
- **输入**：`我爱中国`
- **期望**：红色权重分布 + 蓝色 `的(28.7%)`
- **验证**：浏览器可视化完整显示

### 场景2：特殊token处理（任务7完成后）
- **输入**：完整句子
- **期望**：显示 `</s>(概率%)` 不隐藏
- **验证**：特殊token正常显示

### 场景3：因果关系理解（任务5完成后）
- **输入**：任意文本
- **期望**：用户能理解红→蓝的因果关系
- **验证**：视觉流向清晰，说明文字到位

## 关键技术依赖

- **模型类型**：AutoModelForCausalLM (已验证可行)
- **API调用**：`output_attentions=True` 同时获取注意力和logits
- **前端框架**：现有Flask + 原生HTML/JS/CSS
- **性能要求**：复用现有模型加载，无显著延迟

## 风险控制

- **最高风险**：模型API变更 → 任务1优先验证
- **中等风险**：前端集成复杂 → 任务4尽早验证端到端
- **低风险**：样式和错误处理 → 后续优化